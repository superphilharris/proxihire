<?php

// 1. Display the properties sliders
$mainProperties = getMainProperties($this->assetList);

// 2. Display each of the assets
foreach( $this->assetList as $asset ){
	$url = "http://myawesomewebsite.com/" . $asset->getId();
	?>
	
	
	<div class="panel panel-default assetPanel" onmouseover="bounceMarker('<?php echo $url ?>')" data-assetid="<?php echo $asset->getId(); ?>">
		<div class="panel-heading"><a target="_blank" href="<?php echo $asset->getUrl()->getPath() ?>"><?php echo $asset->getUrl()->getTitle() ?></a></div>
		<div class="panel-body">
			<img src="/img/assets/<?php echo $asset->getImage() ?>" class="img-responsive" style="float:left; width:120px; margin:-15px"/>
			
			<div class="assetPropertiesSummary">
			<?php 
			foreach($asset->getProperties() as $property){
				$propertyName 	= $property->getName();
				$propertyValue 	= $property->getValue();
				echo '<div class="'.$propertyName.'_propertySummary"><span class="propertyName">'.ucwords($propertyName).'</span>:&nbsp;<span class="propertyValue">'.$propertyValue.'</span></div>'; 
			}
			?>
			</div>
			<?php 
			foreach($asset->getProperties() as $property){
				$propertyName 	= $property->getName();
				$propertyValue 	= $property->getValue();
				echo '<div class="assetPropertyColumn '.str_replace(' ','_',$propertyName).'_column"><span>'.$propertyValue.'</span></div>'; 
			}
			?>
		</div>
	</div>
	
	
	<?php
}


// 3. Bounce the location on the map when hovering
?>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function(){ 
	<?php 
	
	// 1. Add all the markers to the map
	foreach( $this->assetList as $asset ){
		$latitude = -36.862043 + rand(-10,10)/300;
		$longitude = 174.761066 + rand(-10, 10)/500;
		$url = "http://myawesomewebsite.com/" . $asset->getId();
		echo 'allAssets.push({id:'.$asset->getId().',lat:'.$latitude.',long:'.$longitude.',url:"'.$url.'"});';
	}
	?>
	showAllMarkers();
}, false);
</script>




<?php 
/**
 * Takes in an array of assets and determines which are the main properties for all these assets,
 * with their min and max values
 * @param array $assetList
 * @return array
 */
function getMainProperties($assetList){
	/* Find the:
	 * - total number of assets that use this property
	 * - if numeric, then get the min and max of this property
	 * - if non-numeric, then get all the possible values for this property
	 */
	$allProperties = array();
	foreach($assetList as $asset){
		foreach($asset->getProperties() as $property){
			$propertyName 	= $property->getName();
			$propertyValue 	= $property->getValue();
			if(isset($allProperties[$propertyName])){
				$allProperties[$propertyName]['count'] ++;
				if(is_numeric($propertyValue)){
					$allProperties[$propertyName]['min'] = min($propertyValue, $allProperties[$propertyName]['min']);
					$allProperties[$propertyName]['max'] = max($propertyValue, $allProperties[$propertyName]['max']);
				}else{
					if(!in_array($propertyValue, $allProperties[$propertyName]['val'])){
						array_push($allProperties[$propertyName]['val'], $propertyValue);
					}
				}
			}else{
				$allProperties[$propertyName] = array('count' => 1 );
				if(is_numeric($propertyValue)){
					$allProperties[$propertyName]['min'] = $propertyValue;
					$allProperties[$propertyName]['max'] = $propertyValue;
				}else{
					$allProperties[$propertyName]['val'] = array($propertyValue);
				}
			}
			
		}
	}

	// Return only the properties that 80% of the assets have
	$totalAssets = count($allProperties);
	$mainProperties = array();
	foreach($allProperties as $propertyName => $propertySummary){
		if($propertySummary['count']/$totalAssets >= 0.8){
			$mainProperties[$propertyName] =$propertySummary;
		}
	}
	return $mainProperties;
}
?>
