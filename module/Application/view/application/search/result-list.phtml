<?php

// 1. Display the properties sliders
$allProperties = getAllProperties($this->assetList);


// 2. Display each of the assets
foreach( $this->assetList as $asset ){
	?>
	
	<div class="panel panel-default assetPanel" onmouseover="bounceMarker('<?php echo $asset->getLessorId() ?>')" data-assetid="<?php echo $asset->getId(); ?>">
		<div class="panel-heading"><a target="_blank" href="<?php echo $asset->getUrl()->getPath() ?>"><?php echo $asset->getUrl()->getTitle() ?></a></div>
		<div class="panel-body">
			<div class="assetImageWrapper"><img src="/img/<?php echo $asset->getImageForSize(120, 120) ?>"/></div>
			
			<div class="assetPropertiesSummary">
			<?php 
			foreach($asset->getProperties() as $property){
				$propertyName 	= $property->getName();
				list($value, $unit) = $property->getValueAndUnit();
				if($propertyName === ""){
					echo '<div class="unnamedPropertySummary propertyWrapper"><span><span class="propertyValue">'.$value.'</span><span class="propertyUnit">'.$unit.'</span></span></div>';
				}else{
					echo '<div class="'.getCssPropertyName($propertyName).'_propertySummary propertyWrapper"><span class="propertyNameAndColon"><span class="propertyName">'.ucwords($propertyName).'</span>:</span><span class="propertyValueAndUnit"><span class="propertyValue">'.$value.'</span><span class="propertyUnit">'.$unit.'</span></span></div>';
				} 
			}
			?>
			</div>
		</div>
	</div>
	
	
	<?php
}


// 3. Bounce the location on the map when hovering
?>
<script type="text/javascript">
document.addEventListener('DOMContentLoaded', function(){ 
	<?php 
	
	// 1. Add all the markers to the map
	foreach( $this->lessorList as $lessor ){
		foreach( $lessor->getBranches() as $branch ){
			$location = $branch->getLocation();
			echo 'allBranches.push({lessorId:'.$lessor->getId().',lat:'.$location->getLatitude().',long:'.$location->getLongitude().',lessorName:"'.$lessor->getName().'"}); ';
		}
	}
	?>
	showAllMarkers();
}, false);
</script>




<?php 
/**
 * Takes in an array of assets and determines which are the main properties for all these assets,
 * with their min and max values
 * @param array $assetList
 * @return array
 */
function getAllProperties($assetList){
	/* Find the:
	 * - total number of assets that use this property
	 * - if numeric, then get the min and max of this property
	 * - if non-numeric, then get all the possible values for this property
	 */
	$allProperties = array();
	foreach($assetList as $asset){
		foreach($asset->getProperties() as $property){
			$propertyName 	= $property->getName();
			$propertyValue 	= $property->getValue();

			if(isset($allProperties[$propertyName])){
				$allProperties[$propertyName]['count'] ++;
			}else{
				$allProperties[$propertyName] = array(
					'count' 	=> 1,
					'min'		=> null,
					'max'		=> null,
					'average'	=> null,
					'val'		=> array()
				);
			}
			if(is_numeric($propertyValue)){
				$propertyValue = floatval($propertyValue);
				if($allProperties[$propertyName]['min'] == null){
					$allProperties[$propertyName]['min'] 		= $propertyValue;
					$allProperties[$propertyName]['max'] 		= $propertyValue;
					$allProperties[$propertyName]['average'] 	= $propertyValue;
				}else{
					$allProperties[$propertyName]['min'] 		= min($propertyValue, $allProperties[$propertyName]['min']);
					$allProperties[$propertyName]['max'] 		= max($propertyValue, $allProperties[$propertyName]['max']);
					$allProperties[$propertyName]['average'] 	= $allProperties[$propertyName]['average'] + ($propertyValue - $allProperties[$propertyName]['average'])/$allProperties[$propertyName]['count'];
				}
			}else if(!in_array($propertyValue, $allProperties[$propertyName]['val'])){
				array_push($allProperties[$propertyName]['val'], $propertyValue);
			}
		}
	}
	return $allProperties;
}

function getCssPropertyName($propertyName){
	return preg_replace('/[^_a-zA-Z0-9-]/', '_', $propertyName);
}
?>
